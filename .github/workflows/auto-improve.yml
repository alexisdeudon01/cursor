name: Auto-Improve (EvoAgentX)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'Assets/Scripts/**'
      - '.cursor/agents/**'

permissions:
  contents: write
  actions: read

env:
  SKIP_PNG_CONVERSION: "true"

jobs:
  improve:
    name: ğŸ¤– Auto-AmÃ©lioration
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Auto-Pull
        run: |
          echo "ğŸ”„ Sync avec remote..."
          git config user.name "EvoAgentX Bot"
          git config user.email "bot@evoagentx.ai"
          git fetch origin main
          git merge origin/main --no-edit || git reset --hard origin/main
          echo "âœ… SynchronisÃ©"
          git log --oneline -3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests anthropic
          echo "âœ… DÃ©pendances OK"

      - name: â±ï¸ Start Timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Phase 1 - Analyse
        run: |
          echo "ğŸ“Š ANALYSE DU PROJET"
          echo "===================="
          find Assets -type f -name "*.cs" | wc -l | xargs echo "Scripts C#:"
          find Assets -type f -name "*.unity" | wc -l | xargs echo "ScÃ¨nes:"

      - name: ğŸ”‘ Phase 2 - API Check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âŒ ANTHROPIC_API_KEY manquante"
            echo "MODE=basic" >> $GITHUB_ENV
          else
            echo "âœ… ANTHROPIC_API_KEY OK"
            echo "MODE=ai" >> $GITHUB_ENV
          fi

      - name: ğŸ“ˆ Phase 3 - MÃ©triques
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          mkdir -p .github/reports
          python3 .github/scripts/generate_metrics.py

      - name: ğŸ¤– Phase 4 - AmÃ©lioration
        id: improve
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 .github/scripts/evoagentx_improve.py
          echo "input_tokens=1000" >> $GITHUB_OUTPUT
          echo "output_tokens=500" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Phase 5 - Ã‰valuation
        id: evaluate
        run: |
          python3 .github/scripts/evaluate_changes.py
          git status --short
          CHANGES=$(git status --porcelain | wc -l)
          if [ "$CHANGES" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’° Phase 6 - Cost Tracking
        run: |
          START=${{ steps.timer.outputs.start_time }}
          END=$(date +%s)
          MINUTES=$(awk "BEGIN {printf \"%.2f\", ($END - $START) / 60}")
          echo "â±ï¸ DurÃ©e: ${MINUTES} min"
          python3 .github/scripts/track_costs.py update 1000 500 $MINUTES || true
          python3 .github/scripts/track_costs.py report || true

      - name: ğŸ’¾ Phase 7 - Commit
        if: steps.evaluate.outputs.has_changes == 'true'
        run: |
          git add -A
          SCORE=$(grep -o '"total_score":[0-9]*' .github/reports/current_metrics.json 2>/dev/null | grep -o '[0-9]*' || echo "N/A")
          COST=$(grep -o '"total_cost_eur":[0-9.]*' .github/config/costs.json 2>/dev/null | grep -o '[0-9.]*' || echo "0")
          git commit -m "ğŸ¤– Auto-improve #${{ github.run_number }} - Score:${SCORE} Cost:â‚¬${COST} [skip ci]"
          git push origin main
          echo "âœ… PushÃ©"

      - name: ğŸ“Š Commit Cost Only
        if: steps.evaluate.outputs.has_changes != 'true'
        run: |
          if ! git diff --quiet .github/config/costs.json 2>/dev/null; then
            git add .github/config/costs.json .github/reports/cost_report.md
            git commit -m "ğŸ“Š Cost update #${{ github.run_number }} [skip ci]" || true
            git push origin main || true
          fi
          echo "â„¹ï¸ Pas d'autres changements"

      - name: ğŸ“‹ RÃ©sumÃ©
        if: always()
        run: |
          python3 .github/scripts/track_costs.py || true
          echo "Run #${{ github.run_number }} - ${{ job.status }}"
