name: Auto-Improve (EvoAgentX)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION: 1 HEURE INTERVAL + 4-CORE RUNNER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CoÃ»t estimÃ©: ~$346/mois (720 runs Ã— ~$0.48/run)
# Temps par run: ~30-35 min
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  schedule:
    - cron: '0 * * * *'  # Toutes les heures (minute 0)
  workflow_dispatch:      # DÃ©clenchement manuel
  push:
    branches: [main]
    paths: ['Assets/**', '.cursor/agents/**']

concurrency:
  group: auto-improve
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"

jobs:
  improve:
    runs-on: ubuntu-latest-4-cores  # 4 vCPU, 16 GB RAM - $0.016/min
    timeout-minutes: 55              # 55 min max (marge de sÃ©curitÃ©)
    permissions:
      contents: write

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          docker system prune -af || true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install evoagentx requests pyyaml

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**') }}
          restore-keys: Library-

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SAVE STATE BEFORE (pour rollback)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Save State Before
        id: before
        run: |
          COMMIT_BEFORE=$(git rev-parse HEAD)
          echo "commit=$COMMIT_BEFORE" >> $GITHUB_OUTPUT
          
          # Copier les fichiers importants
          mkdir -p /tmp/state-before
          cp -r Assets/Scripts /tmp/state-before/ 2>/dev/null || true
          cp .cursor/agents/agent.md /tmp/state-before/ 2>/dev/null || true
          
          echo "âœ… Ã‰tat sauvegardÃ©: $COMMIT_BEFORE"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 1: MÃ‰TRIQUES PAR CLAUDE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Generate Metrics (Claude)
        id: metrics
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 .github/scripts/generate_metrics.py

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 2: EVOAGENTX WORKFLOW
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Run EvoAgentX
        id: evoagentx
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 .github/scripts/evoagentx_improve.py

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 3: Ã‰VALUATION POST-AMÃ‰LIORATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Evaluate Changes
        id: evaluate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 .github/scripts/evaluate_changes.py

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 4: ROLLBACK SI RÃ‰GRESSION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Rollback if Worse
        if: steps.evaluate.outputs.should_rollback == 'true'
        run: |
          echo "âš ï¸ RÃ‰GRESSION DÃ‰TECTÃ‰E - ROLLBACK"
          echo "Score avant: ${{ steps.evaluate.outputs.score_before }}"
          echo "Score aprÃ¨s: ${{ steps.evaluate.outputs.score_after }}"
          
          # Restaurer les fichiers
          cp -r /tmp/state-before/Scripts Assets/ 2>/dev/null || true
          cp /tmp/state-before/agent.md .cursor/agents/ 2>/dev/null || true
          
          # Marquer le rollback
          echo "ROLLBACK at $(date)" >> .github/reports/rollback-history.txt
          
          echo "âœ… Rollback effectuÃ©"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 5: BUILD UNITY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Build Unity
        id: unity-build
        uses: game-ci/unity-builder@v4
        continue-on-error: true
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: StandaloneLinux64
          buildName: TheBestGame
          buildsPath: Build
          unityVersion: 6000.0.23f1

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 6: ROLLBACK SI BUILD Ã‰CHOUE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Rollback if Build Failed
        if: steps.unity-build.outcome == 'failure'
        run: |
          echo "âŒ BUILD Ã‰CHOUÃ‰ - ROLLBACK"
          
          # Restaurer
          cp -r /tmp/state-before/Scripts Assets/ 2>/dev/null || true
          cp /tmp/state-before/agent.md .cursor/agents/ 2>/dev/null || true
          
          echo "BUILD_FAILED at $(date)" >> .github/reports/rollback-history.txt
          echo "âœ… Rollback effectuÃ©"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # UPLOAD & COMMIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Upload Build
        if: steps.unity-build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: TheBestGame-${{ github.run_number }}
          path: Build/StandaloneLinux64
          retention-days: 7

      - name: Update Agent Version
        run: |
          # IncrÃ©menter version dans agent.md
          VERSION=$(grep -oP 'Version\*\*: \K[0-9]+\.[0-9]+\.[0-9]+' .cursor/agents/agent.md || echo "1.0.0")
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          sed -i "s/Version\*\*: $VERSION/Version**: $NEW_VERSION/g" .cursor/agents/agent.md
          sed -i "s/AUTO_DATE/$(date '+%Y-%m-%d %H:%M')/g" .cursor/agents/agent.md
          
          echo "ðŸ“Œ Version: $VERSION â†’ $NEW_VERSION"

      - name: Commit Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Tag pour rollback facile
          git tag -a "pre-improve-${{ github.run_number }}" -m "Before improvement #${{ github.run_number }}" 2>/dev/null || true
          
          echo -e "Build/\nLibrary/\nTemp/\nLogs/" >> .gitignore
          
          git add -A
          git reset -- Build/ Library/ Temp/ Logs/
          
          if git diff --staged --quiet; then
            echo "âœ… Pas de changements"
            exit 0
          fi
          
          SCORE="${{ steps.evaluate.outputs.score_after }}"
          git commit -m "ðŸ¤– Auto-improve #${{ github.run_number }} (score: ${SCORE:-N/A}) [skip ci]"
          
          # Push avec retry
          for i in 1 2 3; do
            git push origin main --tags && exit 0
            git pull --rebase origin main
            sleep 2
          done
