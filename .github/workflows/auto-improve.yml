name: Auto-Improve (EvoAgentX)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'Assets/Scripts/**'
      - '.cursor/agents/**'

permissions:
  contents: write
  actions: read

env:
  SKIP_PNG_CONVERSION: "true"

jobs:
  improve:
    name: ğŸ¤– Auto-AmÃ©lioration
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Auto-Pull
        run: |
          echo "ğŸ”„ Sync avec remote..."
          git config user.name "EvoAgentX Bot"
          git config user.email "bot@evoagentx.ai"
          git fetch origin main
          git merge origin/main --no-edit || git reset --hard origin/main
          echo "âœ… SynchronisÃ©"
          git log --oneline -3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests anthropic
          echo "âœ… DÃ©pendances OK"

      - name: â±ï¸ Start Timer
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Phase 1 - Analyse
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š ANALYSE DU PROJET"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          find Assets -type f -name "*.cs" 2>/dev/null | wc -l | xargs echo "Scripts C#:"
          find Assets -type f -name "*.unity" 2>/dev/null | wc -l | xargs echo "ScÃ¨nes:"
          find Assets -type f -name "*.prefab" 2>/dev/null | wc -l | xargs echo "Prefabs:"
          echo ""
          if [ -f ".cursor/agents/agent.md" ]; then
            echo "âœ… Agent trouvÃ©"
            head -10 .cursor/agents/agent.md
          fi

      - name: ğŸ”‘ Phase 2 - API Check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”‘ VÃ‰RIFICATION API"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âŒ ANTHROPIC_API_KEY manquante"
            echo "MODE=basic" >> $GITHUB_ENV
          else
            echo "âœ… ANTHROPIC_API_KEY configurÃ©e"
            echo "MODE=ai" >> $GITHUB_ENV
          fi

      - name: ğŸ“ˆ Phase 3 - MÃ©triques
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ˆ GÃ‰NÃ‰RATION DES MÃ‰TRIQUES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          mkdir -p .github/reports
          if [ -f ".github/scripts/generate_metrics.py" ]; then
            python3 .github/scripts/generate_metrics.py
          else
            echo '{"total_score": 0, "timestamp": "'$(date -Iseconds)'"}' > .github/reports/current_metrics.json
          fi
          cat .github/reports/current_metrics.json 2>/dev/null || echo "{}"

      - name: ğŸ¤– Phase 4 - AmÃ©lioration
        id: improve
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¤– AMÃ‰LIORATION VIA EVOAGENTX"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ -f ".github/scripts/evoagentx_improve.py" ]; then
            python3 .github/scripts/evoagentx_improve.py
          else
            echo "â„¹ï¸ Script evoagentx_improve.py non trouvÃ©, skip"
          fi
          echo "input_tokens=1000" >> $GITHUB_OUTPUT
          echo "output_tokens=500" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Phase 5 - Ã‰valuation
        id: evaluate
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Ã‰VALUATION DES CHANGEMENTS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ -f ".github/scripts/evaluate_changes.py" ]; then
            python3 .github/scripts/evaluate_changes.py
          fi
          echo ""
          echo "Fichiers modifiÃ©s:"
          git status --short
          CHANGES=$(git status --porcelain | wc -l)
          echo "Total: $CHANGES fichiers"
          if [ "$CHANGES" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’° Phase 6 - Cost Tracking
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’° TRACKING DES COÃ›TS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          START=${{ steps.timer.outputs.start_time }}
          END=$(date +%s)
          MINUTES=$(awk "BEGIN {printf \"%.2f\", ($END - $START) / 60}")
          echo "â±ï¸ DurÃ©e: ${MINUTES} min"
          
          if [ -f ".github/scripts/track_costs.py" ]; then
            python3 .github/scripts/track_costs.py update 1000 500 $MINUTES || true
            python3 .github/scripts/track_costs.py report || true
          fi

      - name: ğŸ’¾ Phase 7 - Commit
        if: steps.evaluate.outputs.has_changes == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’¾ COMMIT DES AMÃ‰LIORATIONS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          git add -A
          SCORE=$(grep -o '"total_score":[0-9]*' .github/reports/current_metrics.json 2>/dev/null | grep -o '[0-9]*' || echo "N/A")
          COST=$(grep -o '"total_cost_eur":[0-9.]*' .github/config/costs.json 2>/dev/null | grep -o '[0-9.]*' || echo "0")
          git commit -m "ğŸ¤– Auto-improve #${{ github.run_number }} - Score:${SCORE} Cost:â‚¬${COST} [skip ci]"
          git push origin main
          echo "âœ… PushÃ©"

      - name: ğŸ“Š Commit Cost Only
        if: steps.evaluate.outputs.has_changes != 'true'
        run: |
          if ! git diff --quiet .github/config/costs.json 2>/dev/null; then
            git add .github/config/costs.json .github/reports/ 2>/dev/null || true
            git commit -m "ğŸ“Š Cost update #${{ github.run_number }} [skip ci]" || true
            git push origin main || true
          fi
          echo "â„¹ï¸ Pas d'autres changements"

      - name: ğŸ“‹ RÃ©sumÃ©
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    ğŸ“‹ RÃ‰SUMÃ‰                          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Run: #${{ github.run_number }}"
          echo "â•‘  Mode: ${{ env.MODE }}"
          echo "â•‘  Status: ${{ job.status }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ -f ".github/scripts/track_costs.py" ]; then
            python3 .github/scripts/track_costs.py || true
          fi
