name: CI (Unity + GHCR cache + Claude AutoFix)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  packages: write

concurrency:
  group: ci-main
  cancel-in-progress: true

env:
  UNITY_PROJECT_PATH: .
  UNITY_PLATFORM: StandaloneLinux64
  UNITY_LOG_DIR: .ci_logs
  MAX_AI_ITERS: "5"

jobs:
  unity:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Preflight (repo sanity)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${UNITY_LOG_DIR}"
          echo "Branch: ${GITHUB_REF_NAME}" | tee "${UNITY_LOG_DIR}/preflight.txt"
          echo "Commit: ${GITHUB_SHA}" | tee -a "${UNITY_LOG_DIR}/preflight.txt"
          echo "Unity project path: ${UNITY_PROJECT_PATH}" | tee -a "${UNITY_LOG_DIR}/preflight.txt"
          test -d "Assets" || (echo "❌ Missing Assets/ (not a Unity project?)" && exit 1)
          test -d "ProjectSettings" || (echo "❌ Missing ProjectSettings/" && exit 1)
          test -f "ProjectSettings/ProjectVersion.txt" || (echo "❌ Missing ProjectSettings/ProjectVersion.txt" && exit 1)
          echo "✅ Project looks like Unity"

      - name: Docker info
        shell: bash
        run: |
          set -euo pipefail
          docker version
          docker info | sed -n '1,140p'

      - name: Login to GHCR (for pull/push cache)
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Resolve latest compatible Unity Editor image (Claude chooses) + push cache to your GHCR
        id: resolve_image
        shell: bash
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          UNITY_VERSION="$(awk '/m_EditorVersion:/ {print $2}' ProjectSettings/ProjectVersion.txt | tr -d '\r')"
          if [[ -z "${UNITY_VERSION:-}" ]]; then
            echo "❌ Could not read Unity version from ProjectSettings/ProjectVersion.txt"
            exit 1
          fi
          echo "Unity version detected: ${UNITY_VERSION}"

          echo "Fetching tags from ghcr.io/game-ci/unity-editor ..."
          TAGS_JSON="$(curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" "https://ghcr.io/v2/game-ci/unity-editor/tags/list?n=10000")"
          # Keep only likely linux editor tags for this exact Unity version
          CANDIDATES="$(echo "$TAGS_JSON" | jq -r '.tags[]' \
            | grep -E "^ubuntu-${UNITY_VERSION}-linux" \
            | head -n 200 || true)"

          if [[ -z "${CANDIDATES:-}" ]]; then
            echo "❌ No tags found for ubuntu-${UNITY_VERSION}-linux*"
            echo "Tip: check your ProjectVersion or switch Unity version."
            exit 1
          fi

          echo "Candidate tags (first 30):"
          echo "$CANDIDATES" | head -n 30

          # Default model if vars.ANTHROPIC_MODEL is empty
          MODEL="${ANTHROPIC_MODEL:-claude-3-5-sonnet-20241022}"

          PROMPT=$'You are selecting the best Docker tag for running Unity CI on Linux. Context:\n- Unity version must match exactly: '${UNITY_VERSION}$'\n- Prefer tags that work best for CI builds/tests. If multiple, prefer IL2CPP images.\n- Output STRICTLY one line: the chosen tag only (no quotes, no explanation).\n\nCandidate tags:\n'${CANDIDATES}$'\n'

          # If no key, just pick the first candidate (still works)
          if [[ -z "${ANTHROPIC_API_KEY:-}" ]]; then
            echo "⚠️ ANTHROPIC_API_KEY missing -> fallback to first candidate"
            CHOSEN_TAG="$(echo "$CANDIDATES" | head -n 1)"
          else
            echo "Asking Claude to choose the best tag..."
            REQ="$(jq -n \
              --arg model "$MODEL" \
              --arg text "$PROMPT" \
              '{model:$model, max_tokens:80, messages:[{role:"user", content:$text}] }')"

            RESP="$(curl -fsSL "https://api.anthropic.com/v1/messages" \
              -H "content-type: application/json" \
              -H "x-api-key: ${ANTHROPIC_API_KEY}" \
              -H "anthropic-version: 2023-06-01" \
              -d "$REQ")"

            CHOSEN_TAG="$(echo "$RESP" | jq -r '.content[0].text' | head -n 1 | tr -d '\r' | xargs)"
            if [[ -z "${CHOSEN_TAG:-}" || "${CHOSEN_TAG}" == "null" ]]; then
              echo "⚠️ Claude returned empty -> fallback to first candidate"
              CHOSEN_TAG="$(echo "$CANDIDATES" | head -n 1)"
            fi

            # Safety: ensure chosen tag is in candidates, else fallback
            if ! echo "$CANDIDATES" | grep -qx "$CHOSEN_TAG"; then
              echo "⚠️ Claude chose tag not in candidates: ${CHOSEN_TAG}"
              echo "Fallback to first candidate."
              CHOSEN_TAG="$(echo "$CANDIDATES" | head -n 1)"
            fi
          fi

          UPSTREAM_IMAGE="ghcr.io/game-ci/unity-editor:${CHOSEN_TAG}"
          CACHE_IMAGE="ghcr.io/${{ github.repository_owner }}/unity-editor-cache:${CHOSEN_TAG}"

          echo "Chosen upstream image: ${UPSTREAM_IMAGE}"
          echo "Will cache to:         ${CACHE_IMAGE}"

          echo "Pull upstream..."
          docker pull "${UPSTREAM_IMAGE}"

          echo "Tag + push cache..."
          docker tag "${UPSTREAM_IMAGE}" "${CACHE_IMAGE}"
          docker push "${CACHE_IMAGE}"

          # Export for next steps
          echo "UNITY_VERSION=${UNITY_VERSION}" >> "$GITHUB_OUTPUT"
          echo "UNITY_EDITOR_IMAGE=${CACHE_IMAGE}" >> "$GITHUB_OUTPUT"
          echo "UNITY_EDITOR_IMAGE=${CACHE_IMAGE}" >> "$GITHUB_ENV"

      - name: Unity compile + tests with Claude AutoFix (up to 5 iters)
        shell: bash
        env:
          # Anthropic
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}
          # Unity licensing (pass-through)
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          # GitHub token for checkpoint commits
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Using cached Unity image: ${UNITY_EDITOR_IMAGE}"
          chmod +x scripts/unity_ai_loop.sh
          ./scripts/unity_ai_loop.sh
      - name: Upload logs + graph
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-and-graph
          path: |
            .ci_logs
            .ci_graph

      - name: Report runner duration proxy (minutes)
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "==== Actions duration (proxy) ===="
          RUN_JSON="$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          DURATION_MS="$(echo "$RUN_JSON" | jq -r '.run_duration_ms // .duration_ms // 0')"
          echo "run_duration_ms=$DURATION_MS"
          DURATION_MS="$DURATION_MS" python3 -c "import os; ms=int(os.environ.get('DURATION_MS','0') or 0); print(f'Approx runner time: {ms/60000:.2f} minutes' if ms else 'Could not read duration.')"
          echo "Cost depends on your GitHub plan (minutes quota / billing)."