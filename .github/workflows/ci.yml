name: CI (Unity + GHCR cache + Claude AutoFix)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: read

concurrency:
  group: ci-main
  cancel-in-progress: true

env:
  UNITY_PROJECT_PATH: .
  UNITY_PLATFORM: StandaloneLinux64
  UNITY_LOG_DIR: .ci_logs
  MAX_AI_ITERS: "5"

  # Image Unity officielle GameCI (GHCR = cache GitHub)
  UNITY_EDITOR_IMAGE: ghcr.io/game-ci/unity-editor:ubuntu-6000.3.0f1-linux-il2cpp-3

jobs:
  unity:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # -------------------------
      # Preflight
      # -------------------------
      - name: Preflight (repo sanity)
        shell: bash
        run: |
          set -e
          mkdir -p "${UNITY_LOG_DIR}"
          echo "Branch: $GITHUB_REF_NAME" | tee "${UNITY_LOG_DIR}/preflight.txt"
          echo "Commit: $GITHUB_SHA" | tee -a "${UNITY_LOG_DIR}/preflight.txt"

          test -d Assets || (echo "❌ Assets/ missing" && exit 1)
          test -d ProjectSettings || (echo "❌ ProjectSettings/ missing" && exit 1)

          echo "✅ Unity project detected"

      # -------------------------
      # Docker diagnostics
      # -------------------------
      - name: Docker info
        shell: bash
        run: |
          docker version
          docker info | head -n 50

      # -------------------------
      # GHCR login (cache images)
      # -------------------------
      - name: Login to GHCR (optional)
        shell: bash
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
          docker login ghcr.io -u "${{ github.actor }}" --password-stdin || true

      # -------------------------
      # Pull Unity image (cache warmup)
      # -------------------------
      - name: Pull Unity Editor image
        shell: bash
        run: |
          docker pull "${UNITY_EDITOR_IMAGE}" || true
          docker images | head -n 10

      # -------------------------
      # Unity compile + tests + AI loop
      # -------------------------
      - name: Unity compile + tests (Claude AutoFix loop)
        shell: bash
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}

          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          chmod +x scripts/unity_ai_loop.sh
          ./scripts/unity_ai_loop.sh

      # -------------------------
      # Upload logs + graph
      # -------------------------
      - name: Upload logs + graph
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-and-graph
          path: |
            .ci_logs
            .ci_graph

      # -------------------------
      # Runner cost (simple, no API, no crash)
      # -------------------------
      - name: Runner cost note
        if: always()
        shell: bash
        run: |
          echo "ℹ️ Runner cost depends on GitHub plan."
          echo "ℹ️ Duration visible in Actions UI → job timing."
