name: CI (Unity + GHCR cache + Claude AutoFix)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  packages: read

concurrency:
  group: ci-main
  cancel-in-progress: true

env:
  # Unity project settings
  UNITY_PROJECT_PATH: .
  UNITY_PLATFORM: StandaloneLinux64
  UNITY_LOG_DIR: .ci_logs
  MAX_AI_ITERS: "5"

  # Prefer GHCR mirror (faster + fewer rate limits). Fallback is handled in the script.
  # ⚠️ If you use a different Unity version, change this tag.
  UNITY_EDITOR_IMAGE: ghcr.io/game-ci/unity-editor:ubuntu-6000.3.0f1-linux-il2cpp-3

jobs:
  unity:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Preflight (repo sanity)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${UNITY_LOG_DIR}"
          echo "Branch: ${GITHUB_REF_NAME}" | tee "${UNITY_LOG_DIR}/preflight.txt"
          echo "Commit: ${GITHUB_SHA}" | tee -a "${UNITY_LOG_DIR}/preflight.txt"
          echo "Unity project path: ${UNITY_PROJECT_PATH}" | tee -a "${UNITY_LOG_DIR}/preflight.txt"
          test -d "Assets" || (echo "❌ Missing Assets/ (not a Unity project?)" && exit 1)
          test -d "ProjectSettings" || (echo "❌ Missing ProjectSettings/" && exit 1)
          echo "✅ Project looks like Unity"

      - name: Docker info
        shell: bash
        run: |
          set -euo pipefail
          docker version
          docker info | sed -n '1,120p'

      - name: Login to GHCR (optional)
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin || true

      - name: Pull Unity Editor image (warm cache)
        shell: bash
        run: |
          set -euo pipefail
          docker pull "${UNITY_EDITOR_IMAGE}" || true
          docker images | head -n 20

      - name: Unity compile + tests with Claude AutoFix (up to 5 iters)
        shell: bash
        env:
          # ✅ Use what you already have in repo/org secrets or env.
          # Anthropic
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}
          # Unity licensing (set any that you use; script will pass through if defined)
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          # GitHub (already provided by Actions, but we pass it explicitly to scripts)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          chmod +x scripts/unity_ai_loop.sh
          ./scripts/unity_ai_loop.sh

      - name: Upload logs + graph
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-and-graph
          path: |
            .ci_logs
            .ci_graph

      - name: Report runner cost proxy (minutes)
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "==== Actions usage (proxy) ===="
          RUN_JSON="$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          DURATION_MS="$(python3 - <<'PY'
import json,sys
j=json.loads(sys.stdin.read())
print(j.get('run_duration_ms') or j.get('duration_ms') or 0)
PY
<<< "$RUN_JSON")"
          echo "run_duration_ms=$DURATION_MS"
          python3 - <<PY
import math
ms = int("$DURATION_MS") if str("$DURATION_MS").isdigit() else 0
mins = ms/60000 if ms else None
print(f"Approx runner time: {mins:.2f} minutes" if mins is not None else "Couldn't read duration.")
print("Cost depends on your GitHub plan (minutes quota / billing).")
PY
